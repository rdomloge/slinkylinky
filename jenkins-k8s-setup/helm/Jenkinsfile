pipeline {
    
    agent { label "helm-worker" }

    environment {
        BUILDER = 'mybuilder'
        FOLDER = "${WORKSPACE}/jenkins-k8s-setup/helm"
    }

    stages {
        stage('Checkout') {
            steps {
                withFolderProperties() {
                    git branch: 'main', url: "https://${env.GITHUB_PERSONAL_ACCESS_TOKEN}@github.com/rdomloge/sl-k8s-scripts.git"
                }
            }
        }

        stage('Generate tenant name') {
            steps {
                script {
                    // Generate a unique tenant name using 3 chars followed by 5 numbers
                    env.TENANT = sh(
                        script: "cat /dev/urandom | tr -dc 'a-z' | head -c3; cat /dev/urandom | tr -dc '0-9' | head -c5",
                        returnStdout: true
                    ).trim()
                    echo "Generated tenant name: ${env.TENANT}"
                }
            }
        }

        stage('Generate Password') {
            steps {
                script {
                    // Generate a 24-character base64 password (strong and URL-safe)
                    env.LINKSERVICE_DB_PASSWORD = sh(
                        script: "openssl rand -base64 24 | tr -d '\\n'",
                        returnStdout: true
                    ).trim()

                    env.KEYCLOAK_DB_PASSWORD = sh(
                        script: "openssl rand -base64 24 | tr -d '\\n'",
                        returnStdout: true
                    ).trim()

                    env.STATS_DB_PASSWORD = sh(
                        script: "openssl rand -base64 24 | tr -d '\\n'",
                        returnStdout: true
                    ).trim()

                    // Optional: verify variable exists but don't echo it
                    echo "Password generated and stored in env var (not printing it for security)"
                    
                    echo "LINKSERVICE_DB_PASSWORD: ${env.LINKSERVICE_DB_PASSWORD}"
                    echo "KEYCLOAK_DB_PASSWORD: ${env.KEYCLOAK_DB_PASSWORD}"
                }
            }
        }

        stage('Deploy platform via Helm') {
            steps {
                script {
                    withFolderProperties() {
                        withKubeConfig(credentialsId: 'prod-k8s', 
                                        serverUrl: "${env.K8S_SERVER_URL}") {

                            sh '''
                            helm install \\
                            --generate-name \\
                            ${FOLDER} \\
                            --set tenant=${TENANT} \\
                            --set LINKSERVICE_DB_PASSWORD=${LINKSERVICE_DB_PASSWORD} \\
                            --set KEYCLOAK_DB_PASSWORD=${KEYCLOAK_DB_PASSWORD} \\
                            --set STATS_DB_PASSWORD=${STATS_DB_PASSWORD}
                            '''
                        }
                    }
                }
            }
        }

        stage('Update secrets in Kubernetes') {
            steps {
                script {
                    withFolderProperties() {
                        withKubeConfig(credentialsId: 'prod-k8s', 
                                        serverUrl: "${env.K8S_SERVER_URL}") {

                            sh '''
                            # Update the existing db-connection-secret created by Helm
                            kubectl -n ${TENANT} patch secret db-connection-secret \\
                              --type='merge' \\
                              -p='{
                                "data": {
                                  "LINKSERVICE_DB_PASSWORD": "'$(echo -n "${LINKSERVICE_DB_PASSWORD}" | base64 -w 0)'",
                                  "KC_DB_PASSWORD": "'$(echo -n "${KEYCLOAK_DB_PASSWORD}" | base64 -w 0)'",
                                  "STATS_DB_PASSWORD": "'$(echo -n "${STATS_DB_PASSWORD}" | base64 -w 0)'"
                                }
                              }'
                            
                

                            # Also update keycloak-credentials secret if it exists
                            if kubectl -n ${TENANT} get secret keycloak-credentials >/dev/null 2>&1; then
                                kubectl -n ${TENANT} patch secret keycloak-credentials \\
                                  --type='merge' \\
                                  -p='{"data":{"KC_DB_PASSWORD":"'$(echo -n "${KEYCLOAK_DB_PASSWORD}" | base64 -w 0)'"}}'
                            fi
                            '''
                        }
                    }
                }
            }
        }

        stage('Create tunnel in Cloudflare, using TENANT variable as sub-domain of slinkylinky.uk') {
            steps {
                script {
                    withFolderProperties() {
                        withKubeConfig(credentialsId: 'prod-k8s', 
                                        serverUrl: "${env.K8S_SERVER_URL}") {

                            sh '''
                            # Create Cloudflare tunnel for the tenant
                            cloudflared tunnel create ${TENANT}-tunnel

                            # Configure the tunnel (assuming config file is pre-defined)
                            cloudflared tunnel route dns ${TENANT}-tunnel ${TENANT}.slinkylinky.uk

                            # Start the tunnel (this may need to be run as a background process or service)
                            cloudflared tunnel run ${TENANT}-tunnel &
                            '''
                        }
                    }
                }
            }
        }

        stage('Update external URI in adminwebsite configmap') {
            steps {
                script {
                    withFolderProperties() {
                        withKubeConfig(credentialsId: 'prod-k8s', 
                                        serverUrl: "${env.K8S_SERVER_URL}") {

                            sh """
                            # Update the admin-website-config ConfigMap with the external URL
                            kubectl -n ${TENANT} patch configmap admin-website-config \\
                              --type='merge' \\
                              -p='{"data":{"NEXTAUTH_URL":"https://${TENANT}.slinkylinky.uk"}}'
                            """
                        }
                    }
                }
            }
        }
    }
}